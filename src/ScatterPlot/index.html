<body>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>
  
    <style>
        * {
          font-family: sans-serif;
        }
        circle {
            fill: green;
        }
    </style>
    <h2>Renewable Energy</h2>
    <p>
      Some text here.
    </p>
    <svg id="chart"></svg>
    <p>
      Some more text here.
    </p>
    <script>
      var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;
  
    // append the svg object to the body of the page
    // append a 'group' element to 'svg'
    // moves the 'group' element to the top left margin
    var svg = d3.select("#chart")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("class", "bar-chart")
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    queue()
        .defer(d3.csv, "../data/Github CBECI Hashrate Data.csv")
        .defer(d3.csv, "../data/Country Renewable Energy Supply.csv")
        .defer(d3.json, "../data/Country Codes.json")
        .await(ready);

    function ready(error, data, renewable, countries) {
        renewable = renewable.filter(d => d.TIME === '2019')
            .map(d => ({
                year: +d.TIME,
                location: d.LOCATION,
                value: +d.Value,
                country: countries.find(c => c.alpha3.toUpperCase() === d.LOCATION)?.en,
            }));
        data = data
            .map(d => ({
                country: d.Country,
                hashrate: +d['Monthly share of total hashrate (%)'],
                year: +d.Date.substring(0, 4),
            }))
            .filter(d => d.year === 2019);
        const dataMap = {};
        data.forEach(d => {
            if (!dataMap[d.country]) dataMap[d.country] = {
                value: 0,
                count: 0,
                renewable: renewable.find(c => c.country === d.country)?.value,
            };
            dataMap[d.country].value += d.hashrate;
            dataMap[d.country].count += 1;
        });
        Object.keys(dataMap).forEach(d => {
            dataMap[d].hashrate = dataMap[d].value / dataMap[d].count;
        });

        const dataMap2 = [];
        Object.keys(dataMap).forEach(d => {
            //if (dataMap[d].renewable && dataMap[d].hashrate) {
            dataMap2.push({ ...dataMap[d], country: d });
            //}
        });

        // Add X axis
        const xmax = d3.max(dataMap2, d => d.renewable);
        var x = d3.scaleLinear()
            .domain([0, xmax])
            .range([ 0, width ]);
        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

        // Add Y axis
        const ymax = d3.max(dataMap2, d => d.hashrate);
        console.log(`ymax: ${ymax}`);
        console.log(dataMap2.filter(d => d.hashrate > 60));
        var y = d3.scaleLinear()
            .domain([0, ymax])
            .range([ height, 0]);
        svg.append("g")
            .call(d3.axisLeft(y));

        console.log(dataMap2);
        // Add dots
        svg.append('g')
            .selectAll("dot")
            .data(dataMap2)
            .enter()
            .append("circle")
                .attr("cx", d => d.renewable )
                .attr("cy", d => d.hashrate )
                .attr("r", 5)
                .style("fill", "#69b3a2");
    }
    
  </script>